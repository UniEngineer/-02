<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>3D Viewer</title>
    <style>
        body { 
            margin: 0;
            padding: 20px;
            font-family: Arial;
            text-align: center;
            background: #f5f5f5;
        }
        #viewer-container {
            width: 100%;
            height: 70vh;
            margin: 20px auto;
            border: 2px dashed #ccc;
            position: relative;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            background: #f0f0f0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #file-input {
            display: none;
        }
    </style>
</head>
<body>
    <h1>3D Просмотрщик моделей</h1>
    <div id="status">Готов к работе!</div>
    
    <button id="upload-btn">Выбрать модель (GLB/GLTF)</button>
    <input type="file" id="file-input" accept=".glb,.gltf">
    
    <div id="viewer-container">
        <div id="viewer"></div>
    </div>

    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    
    <script>
        // Проверка на Telegram WebApp
        const isTelegram = () => {
            return window.Telegram && Telegram.WebApp;
        };
        
        // Инициализация сцены
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({antialias: true});
        let controls;
        
        // Размеры рендерера
        function updateRendererSize() {
            const container = document.getElementById('viewer-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            renderer.setSize(width, height);
            camera.aspect = width/height;
            camera.updateProjectionMatrix();
        }
        
        // Инициализация
        function init() {
            // Настройка рендерера
            const viewer = document.getElementById('viewer');
            viewer.appendChild(renderer.domElement);
            updateRendererSize();
            
            // Освещение
            const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
            light1.position.set(1, 1, 1);
            scene.add(light1);
            
            const light2 = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(light2);
            
            // Камера
            camera.position.z = 5;
            
            // Управление
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Обработчик файлов
            document.getElementById('upload-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            
            document.getElementById('file-input').addEventListener('change', loadModel);
            
            // Реакция на resize
            window.addEventListener('resize', updateRendererSize);
            
            // Для Telegram
            if (isTelegram()) {
                Telegram.WebApp.expand();
                document.getElementById('status').textContent = "Telegram WebApp активен";
            }
            
            // Анимация
            animate();
        }
        
        // Загрузка модели
        function loadModel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            document.getElementById('status').textContent = `Загружаем: ${file.name}...`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const loader = new THREE.GLTFLoader();
                
                loader.load(
                    e.target.result,
                    function(gltf) {
                        // Очищаем сцену
                        while(scene.children.length > 0) {
                            scene.remove(scene.children[0]);
                        }
                        
                        // Добавляем модель
                        scene.add(gltf.scene);
                        
                        // Центрируем камеру
                        const box = new THREE.Box3().setFromObject(gltf.scene);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3()).length();
                        
                        camera.position.copy(center);
                        camera.position.z += size * 1.5;
                        controls.target.copy(center);
                        controls.update();
                        
                        document.getElementById('status').textContent = 
                            `Модель загружена: ${file.name}`;
                    },
                    undefined,
                    function(error) {
                        document.getElementById('status').textContent = 
                            `Ошибка загрузки: ${error.message}`;
                        console.error(error);
                    }
                );
            };
            reader.readAsDataURL(file);
        }
        
        // Анимация
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // Запуск
        init();
    </script>
</body>
</html>
